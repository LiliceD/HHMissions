{% extends 'layout-large.html.twig' %}


{% block title %}
  Fiches mission - {{ parent() }}
{% endblock %}


{% block header_h2 %}
  Liste des fiches mission
{% endblock %}

{% block header_button %}
  {# new mission button only visible for gla (and admin) #}
  {% if is_granted('ROLE_GLA') %}
    <a href="{{ path('app_mission_new') }}" class="btn btn-success">
      <i class="fas fa-plus"></i>
      Créer une fiche mission
    </a>
  {% endif %}
{% endblock %}


{% block content %}
  <h3>Missions en attente :</h3>

  {% if newMissions %}
    <table id="newMissions" class="table table-hover">
      <thead>
        <tr>
          <th scope="col">N°</th>
          <th scope="col">Demande</th>
          <th scope="col">Provenance GLA</th>
          <th scope="col">Adresse</th>
          <th scope="col">Description mission</th>
          {# <th scope="col">Statut</th> #}
          <th></th>
          {% if is_granted('ROLE_GLA') %}
            <th></th>
          {% endif %}
        </tr>
      </thead>

      <tbody>
        {% for mission in newMissions %}
          <tr id="mission-{{ mission.id }}">
            <td>{{ mission.id }}</td>
            <th scope="row">{{ mission.dateCreated|date('d/m/y') }}</th>
            <td>{{ mission.gla }}</td>
            {# address #}
            <td>
              {% if mission.accomodation.name %}
                {{ mission.accomodation.name }} - 
              {% endif %}
              {{ mission.accomodation.street }}
              <br>
              {{ mission.accomodation.postalCode }} {{ mission.accomodation.city }}
            </td>
            <td><div class="text-ellipsis" title="{{ mission.description }}">{{ mission.description }}</div></td>
            {# <td>{{ mission.status }}</td> #}
            {# view button #}
            <td>
              <a href="{{ path('app_mission_view', {'id': mission.id}) }}" class="btn btn-sm btn-primary">
                <i class="fas fa-eye"></i>
                Voir
              </a>
            </td>
            {# edit button only visible for admin or mission's gla #}
            {% if is_granted('edit', mission) %}
              <td>
                <a href="{{ path('app_mission_edit', {'id': mission.id}) }}" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-edit"></i>
                  Modifier
                </a>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    Aucune mission en attente !
  {% endif %}
  <hr>

  <h3>Missions en cours :</h3>

  {% if assignedMissions %}
    {# User role passed to JS through data attributes #}
    <div id="userData" data-name="{{ app.user.name }}" data-is-gla="{{ is_granted('ROLE_GLA') ? true : false }}" data-is-volunteer="{{ is_granted('ROLE_VOLUNTEER') ? 'true' : 'false' }}" class="d-flex align-items-center">
      <input type="checkbox" id="myAssignedMissions" name="myAssignedMissions" class="mb-2" />
      <label for="myAssignedMissions" class="mb-2 ml-2">Afficher uniquement mes missions</label>
    </div>


    <table id="assignedMissions" class="table table-hover">
      <thead class="thead-light">
        <tr>
          <th scope="col">N°</th>
          <th scope="col">Demande</th>
          <th scope="col">Prise en charge</th>
          <th scope="col">Provenance GLA</th>
          <th scope="col">Adresse</th>
          <th scope="col">Bénévole</th>
          <th scope="col">Description</th>
          {# <th scope="col">Statut</th>
          <th></th> #}
          <th></th>
        </tr>
      </thead>

      <tbody>
        {% for mission in assignedMissions %}
          <tr id="mission-{{ mission.id }}">
            <td>{{ mission.id }}</td>
            <th scope="row">{{ mission.dateCreated|date('d/m/y') }}</th>
            <td>{{ mission.dateAssigned|date('d/m/y') }}</td>
            <td>{{ mission.gla }}</td>
            {# address #}
            <td>
              {% if mission.accomodation.name %}
                {{ mission.accomodation.name }} - 
              {% endif %}
              {{ mission.accomodation.street }}
              <br>
              {{ mission.accomodation.postalCode }} {{ mission.accomodation.city }}
            </td>
            <td>{{ mission.volunteer }}</td>
            <td><div class="text-ellipsis" title="{{ mission.description }}">{{ mission.description }}</div></td>
            {# <td>{{ mission.status }}</td> #}
            {# view button #}
            <td>
              <a href="{{ path('app_mission_view', {'id': mission.id}) }}" class="btn btn-sm btn-primary">
                <i class="fas fa-eye"></i>
                Voir
              </a>
            </td>
            {# edit button only visible if user is admin or mission's gla or volunteer #}
            {# {% if is_granted('simpleEdit', mission) %}
              <td>
                <a href="{{ path('app_mission_edit', {'id': mission.id}) }}" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-edit"></i>
                  Modifier
                </a>
              </td>
            {% endif %} #}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    Aucune mission en cours !
  {% endif %}

  <hr>

  <h3>Missions terminées :</h3>

  {# User role passed to JS through data attributes #}
  <div class="d-flex align-items-center">
    <input type="checkbox" id="myFinishedMissions" name="myFinishedMissions" class="mb-2" />
    <label for="myFinishedMissions" class="mb-2 ml-2">Afficher uniquement mes missions</label>
  </div>

  {{ form_start(form) }}
    <div class="d-flex align-items-center my-3">
      <div class="mr-4">
        Filtres :
      </div>

      <div class="dropdown mr-2">
        <button class="btn btn-light dropdown-toggle" type="button" id="dropdownGlaButton" data-toggle="dropdown" data-flip="false" aria-haspopup="true" aria-expanded="false">
          Provenance GLA
        </button>
        <div class="dropdown-menu px-3 mb-3" aria-labelledby="dropdownGlaButton">
          {{ form_widget(form.gla) }}
        </div>
      </div>

      <div class="dropdown mr-2">
        <button class="btn btn-light dropdown-toggle" type="button" id="dropdownVolunteerButton" data-toggle="dropdown" data-flip="false" aria-haspopup="true" aria-expanded="false">
          Bénévole
        </button>
        <div class="dropdown-menu px-3 mb-3" aria-labelledby="dropdownVolunteerButton">
          {{ form_widget(form.volunteer) }}
        </div>
      </div>

      <div class="dropdown mr-4">
        <button class="btn btn-light dropdown-toggle" type="button" id="dropdownAccomodationButton" data-toggle="dropdown" data-flip="false" aria-haspopup="true" aria-expanded="false">
          Adresse d'intervention
        </button>
        <div class="dropdown-menu px-3 mb-3" aria-labelledby="dropdownAccomodationButton">
          {{ form_widget(form.accomodation) }}
        </div>
      </div>

      <input type="submit" class="btn btn-sm btn-primary" id="searchSubmitButton" value="Rechercher" />
    </div>
  {{ form_end(form) }}

  <table id="finishedMissions" class="table table-hover">
    <thead class="thead-light">
      <tr>
        <th scope="col">N°</th>
        <th scope="col">Demande</th>
        {# <th scope="col">Prise en charge</th> #}
        <th scope="col">Fin de mission</th>
        <th scope="col">Provenance GLA</th>
        <th scope="col">Adresse</th>
        <th scope="col">Bénévole</th>
        <th scope="col">Description</th>
        {# <th scope="col">Statut</th> #}
        <th></th>
        {# <th></th> #}
      </tr>
    </thead>

    <tbody>
      {% for mission in finishedMissions %}
        <tr id="mission-{{ mission.id }}" class="{{ mission.status == constant('STATUS_CLOSED', mission) ? 'text-secondary' }}">
          <td>{{ mission.id }}</td>
          <th scope="row">{{ mission.dateCreated|date('d/m/y') }}</th>
          {# <td>{{ mission.dateAssigned|date('d/m/y') }}</td> #}
          <td>{{ mission.dateFinished|date('d/m/y') }}</td>
          <td>{{ mission.gla }}</td>
          {# address #}
          <td>
            {% if mission.accomodation.name %}
              {{ mission.accomodation.name }} - 
            {% endif %}
            {{ mission.accomodation.street }}
            <br>
            {{ mission.accomodation.postalCode }} {{ mission.accomodation.city }}
          </td>
          <td>{{ mission.volunteer }}</td>
          <td><div class="text-ellipsis" title="{{ mission.description }}">{{ mission.description }}</div></td>
          {# <td>{{ mission.status }}</td> #}
          {# view button #}
          <td>
            <a href="{{ path('app_mission_view', {'id': mission.id}) }}" class="btn btn-sm btn-primary">
              <i class="fas fa-eye"></i>
              Voir
            </a>
          </td>
          {# edit button only visible if mission is not closed and user is admin or mission's gla or volunteer #}
          {# {% if mission.status != constant('STATUS_CLOSED', mission) and is_granted('simpleEdit', mission) %}
            <td>
              <a href="{{ path('app_mission_edit', {'id': mission.id}) }}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-edit"></i>
                Modifier
              </a>
            </td>
          {% endif %} #}
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endblock %}


{% block javascripts %}
  {{ parent() }}

  <script>
    (function() {
      let name, isGla, isVolunteer,
          assignedMissionsTable = document.getElementById('assignedMissions'),
          finishedMissionsTable = document.getElementById('finishedMissions');


      // Filter table based on array of filters as array of arrays [td_index, value]
      function filterTable(table, filters) {
        let tr = table.getElementsByTagName("tr");

        // Case unsensitive filter
        filters.forEach(filter => {
          filter[1] = filter[1].toUpperCase();
        });

        // Loop through all table rows, and hide those who don't match the search query
        for (let i = 0, c = tr.length; i < c; i++) {
          td = tr[i].getElementsByTagName("td");

          // For each row, loop through filters elements until there is a match. If no match, hide row
          for (let j = 0, filtersLength = filters.length; j < filters.length; j++) {
            let filterIndex = filters[j][0],
                filterValue = filters[j][1],
                cell = td[filterIndex];

            if (cell) {
              if (cell.innerHTML.toUpperCase() === filterValue) {
                tr[i].style.display = "";
                break;
              } else if (j === filtersLength - 1) {
                tr[i].style.display = "none";
              }
            }
          }
        }
      }

      // Show all table rows
      function unfilterTable(table) {
        let tr = table.getElementsByTagName("tr");

        for (let i = 0, c = tr.length; i < c; i++) {
          tr[i].style.display = "";
        }
      }

      function myMissions(checkbox, table) {
        let filterValue = name.toUpperCase();

        if(checkbox.checked) {
          let filters = [];
          if (isGla) {
            // Column GLA is index 2 in the array of td cells
            filters.push([2, filterValue]);
          }
          if (isVolunteer) {
            // Column GLA is index 4 in the array of td cells
            filters.push([4, filterValue]);
          }
          filterTable(table, filters);
        } else {
          unfilterTable(table);
        }
      }


      // Get user's name, isGla and isVolunteer from Twig
      document.addEventListener('DOMContentLoaded', () => {
        let userDataElt = document.getElementById('userData');
        if (userDataElt) {
          name = userDataElt.getAttribute('data-name');
          isGla = userDataElt.getAttribute('data-is-gla');
          isVolunteer = userDataElt.getAttribute('data-is-volunteer');
        }
      });

      // If myXXXMissions is checked, show only missions where user is gla and/or volunteer
      document.getElementById('myAssignedMissions').addEventListener('change', (e) => {
        myMissions(e.target, assignedMissionsTable);
      });

      document.getElementById('myFinishedMissions').addEventListener('change', (e) => {
        myMissions(e.target, finishedMissionsTable);
      });

      document.getElementById('searchSubmitButton').addEventListener('click', (e) => {
        e.preventDefault();
        console.log('coucou !');
      })
    })();
  </script>
{% endblock %}
